define("qtype_gapfill/gaps",["exports"],(function(_exports){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updateJson=_exports.updateGapClassesFromSettings=_exports.updateGapClasses=_exports.stripdelim=_exports.parseQuestionText=_exports.initializeAllGapClasses=_exports.getItemSettings=_exports.getGap=void 0;_exports.updateJson=(gapInfo,correctFeedback,incorrectFeedback)=>{const settingsdata=document.querySelector("[name='itemsettings']");let parsedSettings={};if(settingsdata&&settingsdata.value)try{const parsedData=JSON.parse(settingsdata.value);Array.isArray(parsedData)?(parsedSettings={},parsedData.forEach((item=>{item.itemid&&(parsedSettings[item.itemid]=item)}))):parsedSettings=parsedData}catch(e){parsedSettings={}}let found=!1;const delimitcharsElement=document.getElementById("id_delimitchars"),delimitchars=delimitcharsElement?delimitcharsElement.value:"";for(const key in parsedSettings)if(parsedSettings[key].itemid===gapInfo.gapId){parsedSettings[key].correctfeedback=correctFeedback,parsedSettings[key].incorrectfeedback=incorrectFeedback,found=!0;break}if(!found){const questionId=document.querySelector("input[name='id']"),itemsettings={itemid:gapInfo.gapId,questionid:questionId?questionId.value:"",correctfeedback:correctFeedback,incorrectfeedback:incorrectFeedback,gaptext:stripdelim(gapInfo.gapText,delimitchars)};parsedSettings[gapInfo.gapId]=itemsettings}const settingsArray=Object.values(parsedSettings);return JSON.stringify(settingsArray)};const stripdelim=(gapText,delimitchars)=>{if(!gapText||!delimitchars||delimitchars.length<2)return gapText;const leftDelim=delimitchars.charAt(0),rightDelim=delimitchars.charAt(1);let gaptextNodelim=gapText;return gapText.charAt(0)===leftDelim&&(gaptextNodelim=gapText.substring(1)),gaptextNodelim.charAt(gaptextNodelim.length-1)===rightDelim&&(gaptextNodelim=gaptextNodelim.substring(0,gaptextNodelim.length-1)),gaptextNodelim};_exports.stripdelim=stripdelim;const escapeRegex=str=>str.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),getItemSettings=gapInfo=>{const itemSettingsField=document.querySelector("[name='itemsettings']");let existingSettings={};if(itemSettingsField&&itemSettingsField.value)try{const parsedData=JSON.parse(itemSettingsField.value);Array.isArray(parsedData)?(existingSettings={},parsedData.forEach((item=>{item.itemid&&(existingSettings[item.itemid]=item)}))):existingSettings=parsedData}catch(e){existingSettings={}}const searchId=gapInfo&&gapInfo.gapId;if(!searchId)return null;const foundObject=Object.values(existingSettings).find((item=>item.itemid===searchId));return foundObject?{correctFeedback:foundObject.correctfeedback,incorrectFeedback:foundObject.incorrectfeedback}:null};_exports.getItemSettings=getItemSettings;_exports.parseQuestionText=questionText=>{const delimitchars=(id=>{const element=document.getElementById(id);return element?element.value:null})("id_delimitchars");if(!delimitchars||2!==delimitchars.length)return questionText;const leftDelim=delimitchars.charAt(0),rightDelim=delimitchars.charAt(1);let processedText=questionText,gapCounter=0;const gapContentCounts=new Map,regex=new RegExp(escapeRegex(leftDelim)+"(.*?)"+escapeRegex(rightDelim),"g");return processedText=processedText.replace(regex,((match,gapContent)=>{var _settings$correctFeed,_settings$incorrectFe;gapCounter++;const currentCount=gapContentCounts.get(gapContent)||0;gapContentCounts.set(gapContent,currentCount+1);const spanId="id"+gapCounter+"_"+currentCount,settings=getItemSettings({gapId:spanId})||{},classes=[];null!==(_settings$correctFeed=settings.correctFeedback)&&void 0!==_settings$correctFeed&&_settings$correctFeed.trim()&&classes.push("hascorrect"),null!==(_settings$incorrectFe=settings.incorrectFeedback)&&void 0!==_settings$incorrectFe&&_settings$incorrectFe.trim()&&classes.push("hasnocorrect");return'<span id="'+spanId+'"'+(classes.length?' class="'+classes.join(" ")+' item"':' class="item"')+">"+match+"</span>"})),processedText};_exports.getGap=clickEvent=>{let gapSpan=clickEvent.target;for(;gapSpan&&"SPAN"!==gapSpan.tagName;)gapSpan=gapSpan.parentNode;return gapSpan&&gapSpan.id&&gapSpan.id.startsWith("id")?{gapId:gapSpan.id,gapText:gapSpan.textContent||gapSpan.innerText}:null};const updateGapClasses=(gapInfo,correctFeedback,incorrectFeedback)=>{const gapSpan=document.getElementById(gapInfo.gapId);gapSpan&&(gapSpan.classList.remove("hascorrect","hasnocorrect"),correctFeedback&&""!==correctFeedback.trim()&&gapSpan.classList.add("hascorrect"),incorrectFeedback&&""!==incorrectFeedback.trim()&&gapSpan.classList.add("hasnocorrect"))};_exports.updateGapClasses=updateGapClasses;_exports.updateGapClassesFromSettings=gapInfo=>{const settings=getItemSettings(gapInfo);settings&&updateGapClasses(gapInfo,settings.correctFeedback,settings.incorrectFeedback)};_exports.initializeAllGapClasses=()=>{const gapSpans=document.querySelectorAll('span[id^="id"]');if(0===gapSpans.length)return;const itemSettingsField=document.querySelector("[name='itemsettings']");if(itemSettingsField&&itemSettingsField.value)try{const parsedData=JSON.parse(itemSettingsField.value);let existingSettings={};Array.isArray(parsedData)?parsedData.forEach((item=>{item.itemid&&(existingSettings[item.itemid]=item)})):existingSettings=parsedData,gapSpans.forEach((gapSpan=>{const gapId=gapSpan.id,settings=existingSettings[gapId];settings&&(gapSpan.classList.remove("hascorrect","hasincorrect"),settings.correctfeedback&&""!==settings.correctfeedback.trim()&&gapSpan.classList.add("hascorrect"),settings.incorrectfeedback&&""!==settings.incorrectfeedback.trim()&&gapSpan.classList.add("hasincorrect"))}))}catch(e){}}}));

//# sourceMappingURL=gaps.min.js.map