/**
 * JavaScript code for the gapfill question type.
 *
 * @copyright  2017 Marcus Green
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("qtype_gapfill/questionedit",["qtype_gapfill/Item"],(function(Item){return{init:function(){function setElementProps(id,properties){var element=document.getElementById(id);element&&Object.keys(properties).forEach((function(prop){element[prop]=properties[prop]}))}function handleAttoItemSettings(){var questionTextEditable=document.getElementById("id_questiontexteditable");if(questionTextEditable.isContentEditable){questionTextEditable.setAttribute("contenteditable","false"),document.getElementById("fitem_id_questiontext").querySelectorAll("button").forEach((function(button){button.setAttribute("disabled","true")}));var settingformheight=window.getComputedStyle(questionTextEditable).height,settingformwidth=window.getComputedStyle(questionTextEditable).width;questionTextEditable.style.display="none";var canvas=document.getElementById("id_itemsettings_canvas"),styles=function(source){var style,name,product={};if(source.length){var dom=source.get(0);if(window.getComputedStyle){var pattern=/-([a-z])/g,uc=function(a,b){return b.toUpperCase()},camelize=function(string){return string.replace(pattern,uc)};if(style=window.getComputedStyle(dom,null))for(var camel,value,i=0,l=style.length;i<l;i++)camel=camelize(name=style[i]),value=style.getPropertyValue(name),product[camel]=value;else if(style=dom.currentStyle)for(name in style)product[name]=style[name];else(style=dom.style)&&(product=function(style,product,name){for(name in style)"function"!=typeof style[name]&&(product[name]=style[name]);return product}(style,product,name));return product}}return!1}(questionTextEditable);Object.assign(canvas.style,styles),questionTextEditable.closest(".editor_atto_content_wrap").appendChild(canvas),canvas.style.position="relative",canvas.style.display="block",canvas.style.background="lightgrey",canvas.innerHTML=questionTextEditable.innerHTML,canvas.style.height=settingformheight,canvas.style.width=settingformwidth,canvas.style.height="100%",canvas.style.width="100%",document.getElementById("id_itemsettings_button").innerHTML=M.util.get_string("editquestiontext","qtype_gapfill"),canvas.style.height=window.getComputedStyle(questionTextEditable).height,wrapContent(canvas)}else{questionTextEditable.style.display="block",questionTextEditable.style.backgroundColor="white",questionTextEditable.setAttribute("contenteditable","true"),document.getElementById("id_itemsettings_canvas").style.display="none",document.getElementById("fitem_id_questiontext").querySelectorAll("button").forEach((function(button){button.removeAttribute("disabled")})),document.getElementById("id_settings_popup").style.display="none",document.getElementById("id_itemsettings_button").innerHTML=M.util.get_string("additemsettings","qtype_gapfill"),document.querySelectorAll('[class^="atto_"]').forEach((function(element){element.removeAttribute("disabled")}))}}document.getElementById("id_answerdisplay").addEventListener("change",(function(){var selected=this.value;"gapfill"==selected&&(setElementProps("id_fixedgapsize",{disabled:!1}),setElementProps("id_optionsaftertext",{disabled:!0,checked:!1}),setElementProps("id_singleuse",{disabled:!0,checked:!1}),setElementProps("id_disableregex",{disabled:!1})),"dragdrop"==selected&&(setElementProps("id_optionsaftertext",{disabled:!1}),setElementProps("id_singleuse",{disabled:!1}),setElementProps("id_fixedgapsize",{disabled:!1}),setElementProps("id_disableregex",{disabled:!1})),"dropdown"==selected&&(setElementProps("id_fixedgapsize",{disabled:!0,checked:!1}),setElementProps("id_optionsaftertext",{disabled:!0,checked:!1}),setElementProps("id_singleuse",{disabled:!0,checked:!1}),setElementProps("id_disableregex",{disabled:!0,checked:!1}))})),document.getElementById("id_itemsettings_button").addEventListener("click",(function(){var activeEditor=document.querySelector(".tox-tinymce")?"tinymce":document.querySelectorAll(".editor_atto").length>0?"atto":null;if(!activeEditor){var errorElement=document.getElementById("id_error_itemsettings_button");return errorElement.style.display="inline",errorElement.style.color="red",void(errorElement.innerHTML=M.util.get_string("itemsettingserror","qtype_gapfill"))}if("atto"===activeEditor)document.querySelectorAll("#questiontext .atto_html_button").forEach((function(button){button.setAttribute("disabled","true")})),handleAttoItemSettings();else if("tinymce"===activeEditor)return void alert("tinymce not implemented yet")})),document.getElementById("id_itemsettings_canvas").addEventListener("click",(function(e){if(!document.getElementById("id_questiontexteditable").isContentEditable&&e.target.id.match(/^id[0-9]+_/)){var delimitchars=document.getElementById("id_delimitchars").value,item=new Item(e.target.innerHTML,delimitchars),itemsettings=item.getItemSettings(e.target);null===itemsettings||0===itemsettings.length?(document.getElementById("id_correcteditable").innerHTML="",document.getElementById("id_incorrecteditable").innerHTML=""):(document.getElementById("id_correcteditable").innerHTML=itemsettings.correctfeedback,document.getElementById("id_incorrecteditable").innerHTML=itemsettings.incorrectfeedback),document.querySelectorAll("label[for*='id_correct']").forEach((function(label){label.textContent=M.util.get_string("correct","qtype_gapfill")})),document.querySelectorAll("label[for*='id_incorrect']").forEach((function(label){label.textContent=M.util.get_string("incorrect","qtype_gapfill")})),document.querySelectorAll("#id_itemsettings_popup .atto_image_button").forEach((function(button){button.setAttribute("disabled","true")})),document.querySelectorAll("#id_itemsettings_popup .atto_media_button").forEach((function(button){button.setAttribute("disabled","true")})),document.querySelectorAll("#id_itemsettings_popup .atto_managefiles_button").forEach((function(button){button.setAttribute("disabled","true")}));var title=M.util.get_string("additemsettings","qtype_gapfill"),tempDiv=document.createElement("div");tempDiv.innerHTML=item.stripdelim(),title+=": "+tempDiv.textContent,require(["jquery","jqueryui"],(function($){$("#id_itemsettings_popup").dialog({position:{my:"right",at:"right",of:"#id_itemsettings_canvas"},height:500,width:"70%",modal:!1,title:title,buttons:[{text:"OK",id:"SaveItemFeedback",click:function(){var JSONstr=item.updateJson(e);document.querySelectorAll('[class^="atto_"]').forEach((function(element){element.removeAttribute("disabled")})),document.querySelector("[name='itemsettings']").value=JSONstr,$(".ui-dialog-content").dialog("close"),document.getElementById("id_questiontexteditable").setAttribute("contenteditable","true"),document.getElementById("id_itemsettings_button").click()}}]})}))}}));var wrapContent=function(el){var node,frag,text,count=0,gaps=[],nodes=function(obj){for(var arr=[],i=0,iLen=obj.length;i<iLen;i++)arr.push(obj[i]);return arr}((el=el&&el.parentNode?el:document.body).childNodes);"id_questiontextfeedback"===el.id&&count>0&&(count=0);for(var sp,delimitchars=document.getElementById("id_delimitchars").value,l=delimitchars.substring(0,1),r=delimitchars.substring(1,2),regex=new RegExp("(\\"+l+".*?\\"+r+")","g"),span=document.createElement("span"),skip={script:"",button:"",input:"",select:"",textarea:"",option:""},i=0,iLen=nodes.length;i<iLen;i++)if(1!==(node=nodes[i]).nodeType||node.tagName.toLowerCase()in skip){if(3===node.nodeType){var textsplit=new RegExp("(\\"+l+".*?\\"+r+")","g");if(text=node.data.split(textsplit)){frag=document.createDocumentFragment();for(var j=0,jLen=text.length;j<jLen;j++)doGap(text,span,j)}node.parentNode.replaceChild(frag,node)}}else wrapContent(node);function doGap(text,span,j){if(gaps=[],regex.test(text[j])){sp=span.cloneNode(!1),count++,sp.className="item";var item=new Item(text[j],document.getElementById("id_delimitchars").value);if(item.gaptext>""){for(var instance=0,k=0;k<gaps.length;++k)gaps[k]===item.text&&instance++;item.id="id"+count+"_"+instance,sp.id=item.id;var is=item.getItemSettings(item);item.striptags(is.correctfeedback)>""&&(sp.className="hascorrect"),item.striptags(is.incorrectfeedback)>""&&(sp.className=sp.className+" hasnocorrect"),gaps.push(item.gaptext)}sp.appendChild(document.createTextNode(text[j])),frag.appendChild(sp)}else frag.appendChild(document.createTextNode(text[j]))}}}}}));

//# sourceMappingURL=questionedit.min.js.map