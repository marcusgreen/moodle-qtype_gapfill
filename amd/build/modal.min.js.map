{"version":3,"file":"modal.min.js","sources":["../src/modal.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JavaScript code for handling the gap settings modal.\n *\n * @module qtype_gapfill/modal\n * @copyright  2025 Marcus Green\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalFactory from 'core/modal_factory';\nimport ModalEvents from 'core/modal_events';\nimport Log from 'core/log';\nimport Templates from 'core/templates';\n\n// Import functions from gaps.js that are needed\nimport {\n    updateJson,\n    getItemSettings,\n    stripdelim,\n    updateGapClasses,\n    updateGapClassesFromSettings\n} from 'qtype_gapfill/gaps';\n\n/**\n * Show gap settings modal for a specific gap\n * @param {Object} gapInfo - Object containing gap information\n * @param {string} gapInfo.gapId - Unique identifier for the gap\n * @param {string} gapInfo.gapText - The text content of the gap\n */\nconst showGapSettingsModal = async(gapInfo) => {\n    // Get language strings\n    const correctLabel = M.util.get_string('correct', 'qtype_gapfill');\n    const incorrectLabel = M.util.get_string('incorrect', 'qtype_gapfill');\n\n    // Get delimiter characters and strip them from gap text for cleaner display\n    const delimitcharsElement = document.getElementById('id_delimitchars');\n    const delimitchars = delimitcharsElement ? delimitcharsElement.value : '[]';\n    const cleanGapText = stripdelim(gapInfo.gapText, delimitchars);\n    const titleString = M.util.get_string('additemsettings', 'qtype_gapfill') + ': ' + cleanGapText;\n\n    // Render the Mustache template with language strings\n    const templateContext = {\n        correct: correctLabel,\n        incorrect: incorrectLabel\n    };\n    const bodyContent = await Templates.render('qtype_gapfill/gapfeedback_modal', templateContext);\n\n    // Create modal using ModalFactory\n    const modal = await ModalFactory.create({\n        type: ModalFactory.types.SAVE_CANCEL,\n        title: titleString,\n        body: bodyContent,\n        large: true,\n    });\n\n    let correctEditorInstance = null;\n    let incorrectEditorInstance = null;\n\n    // Show the modal\n    modal.show();\n\n    // Update gap classes based on existing feedback when modal loads\n    updateGapClassesFromSettings(gapInfo);\n\n    // After modal is shown, initialize TinyMCE editors for the feedback fields\n    modal.getRoot().on(ModalEvents.shown, async() => {\n        // Wait a moment for DOM to be ready\n        await new Promise(resolve => setTimeout(resolve, 300));\n\n        // Get the TinyMCE instance from the global scope\n        /* global tinyMCE */\n        // Clean up any existing TinyMCE instances for these elements\n        const correctEditor = tinyMCE.get('gapfill-feedback-correct');\n        if (correctEditor) {\n            correctEditor.remove();\n        }\n        const incorrectEditor = tinyMCE.get('gapfill-feedback-incorrect');\n        if (incorrectEditor) {\n            incorrectEditor.remove();\n        }\n\n        const feedback = getItemSettings(gapInfo);\n\n        // Initialize TinyMCE for both feedback fields with a single init call\n        try {\n            await tinyMCE.init({\n                selector: '#gapfill-feedback-correct, #gapfill-feedback-incorrect',\n                menubar: false,\n                toolbar: 'undo redo | formatselect | bold italic | bullist numlist | link unlink',\n                plugins: 'lists link',\n                height: 150, // Set height to approximately 4 rows\n                setup: (ed) => {\n                    ed.on('init', () => {\n                        const editorId = ed.id;\n                        const content = editorId === 'gapfill-feedback-correct'\n                            ? (feedback && feedback.correctFeedback) || ''\n                            : (feedback && feedback.incorrectFeedback) || '';\n                        if (editorId === 'gapfill-feedback-correct') {\n                            correctEditorInstance = ed;\n                        } else {\n                            incorrectEditorInstance = ed;\n                        }\n                        ed.setContent(content);\n                    });\n                }\n            });\n        } catch (error) {\n            Log.debug('Failed to initialize TinyMCE:', error);\n        }\n\n        // Set up save event handler after TinyMCE is ready\n        modal.getRoot().on(ModalEvents.save, (e) => {\n            e.preventDefault();\n\n            const correctFeedback = correctEditorInstance ? correctEditorInstance.getContent() : '';\n            const incorrectFeedback = incorrectEditorInstance ? incorrectEditorInstance.getContent() : '';\n\n            // Update the JSON data\n            const JSONstr = updateJson(gapInfo, correctFeedback, incorrectFeedback);\n\n            // Save to the hidden field\n            const itemSettingsField = document.querySelector(\"[name='itemsettings']\");\n            if (itemSettingsField) {\n                itemSettingsField.value = JSONstr;\n            }\n\n            // Update gap classes based on the new feedback\n            updateGapClasses(gapInfo, correctFeedback, incorrectFeedback);\n\n            // Close the modal\n            modal.hide();\n        });\n\n    });\n\n    // Clean up TinyMCE instances when modal is hidden\n    modal.getRoot().on(ModalEvents.hidden, () => {\n        if (tinyMCE) {\n            const correctEditor = tinyMCE.get('gapfill-feedback-correct');\n            if (correctEditor) {\n                correctEditor.remove();\n            }\n\n            const incorrectEditor = tinyMCE.get('gapfill-feedback-incorrect');\n            if (incorrectEditor) {\n                incorrectEditor.remove();\n            }\n        }\n    });\n};\n\nexport {\n    showGapSettingsModal\n};"],"names":["async","correctLabel","M","util","get_string","incorrectLabel","delimitcharsElement","document","getElementById","delimitchars","value","cleanGapText","gapInfo","gapText","titleString","templateContext","correct","incorrect","bodyContent","Templates","render","modal","ModalFactory","create","type","types","SAVE_CANCEL","title","body","large","correctEditorInstance","incorrectEditorInstance","show","getRoot","on","ModalEvents","shown","Promise","resolve","setTimeout","correctEditor","tinyMCE","get","remove","incorrectEditor","feedback","init","selector","menubar","toolbar","plugins","height","setup","ed","editorId","id","content","correctFeedback","incorrectFeedback","setContent","error","debug","save","e","preventDefault","getContent","JSONstr","itemSettingsField","querySelector","hide","hidden"],"mappings":";;;;;;;0TA2C6BA,MAAAA,gBAEnBC,aAAeC,EAAEC,KAAKC,WAAW,UAAW,iBAC5CC,eAAiBH,EAAEC,KAAKC,WAAW,YAAa,iBAGhDE,oBAAsBC,SAASC,eAAe,mBAC9CC,aAAeH,oBAAsBA,oBAAoBI,MAAQ,KACjEC,cAAe,oBAAWC,QAAQC,QAASJ,cAC3CK,YAAcZ,EAAEC,KAAKC,WAAW,kBAAmB,iBAAmB,KAAOO,aAG7EI,gBAAkB,CACpBC,QAASf,aACTgB,UAAWZ,gBAETa,kBAAoBC,mBAAUC,OAAO,kCAAmCL,iBAGxEM,YAAcC,uBAAaC,OAAO,CACpCC,KAAMF,uBAAaG,MAAMC,YACzBC,MAAOb,YACPc,KAAMV,YACNW,OAAO,QAGPC,sBAAwB,KACxBC,wBAA0B,KAG9BV,MAAMW,8CAGuBpB,SAG7BS,MAAMY,UAAUC,GAAGC,sBAAYC,OAAOpC,gBAE5B,IAAIqC,SAAQC,SAAWC,WAAWD,QAAS,aAK3CE,cAAgBC,QAAQC,IAAI,4BAC9BF,eACAA,cAAcG,eAEZC,gBAAkBH,QAAQC,IAAI,8BAChCE,iBACAA,gBAAgBD,eAGdE,UAAW,yBAAgBjC,mBAIvB6B,QAAQK,KAAK,CACfC,SAAU,yDACVC,SAAS,EACTC,QAAS,yEACTC,QAAS,aACTC,OAAQ,IACRC,MAAQC,KACJA,GAAGnB,GAAG,QAAQ,WACJoB,SAAWD,GAAGE,GACdC,QAAuB,6BAAbF,SACTT,UAAYA,SAASY,iBAAoB,GACzCZ,UAAYA,SAASa,mBAAsB,GACjC,6BAAbJ,SACAxB,sBAAwBuB,GAExBtB,wBAA0BsB,GAE9BA,GAAGM,WAAWH,eAI5B,MAAOI,oBACDC,MAAM,gCAAiCD,OAI/CvC,MAAMY,UAAUC,GAAGC,sBAAY2B,MAAOC,IAClCA,EAAEC,uBAEIP,gBAAkB3B,sBAAwBA,sBAAsBmC,aAAe,GAC/EP,kBAAoB3B,wBAA0BA,wBAAwBkC,aAAe,GAGrFC,SAAU,oBAAWtD,QAAS6C,gBAAiBC,mBAG/CS,kBAAoB5D,SAAS6D,cAAc,yBAC7CD,oBACAA,kBAAkBzD,MAAQwD,oCAIbtD,QAAS6C,gBAAiBC,mBAG3CrC,MAAMgD,aAMdhD,MAAMY,UAAUC,GAAGC,sBAAYmC,QAAQ,QAC/B7B,QAAS,OACHD,cAAgBC,QAAQC,IAAI,4BAC9BF,eACAA,cAAcG,eAGZC,gBAAkBH,QAAQC,IAAI,8BAChCE,iBACAA,gBAAgBD"}